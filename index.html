<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Muğla Büyükşehir Belediyesi - Tutanak Düzenleyici</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.31.0/docxtemplater.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/2.6.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip-utils/0.1.0/jszip-utils.min.js"></script>
    <style>
        /* CSS kodu aynı kalabilir */
    </style>
</head>
<body>
    <!-- HTML form kısmı aynı kalabilir -->
    
    <script>
        let templateFile = null;

        // Word şablonunu yükle
        document.getElementById('templateFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                templateFile = file;
                showStatus("Word şablonu başarıyla yüklendi.", "success");
            }
        });

        function showStatus(message, type) {
            const statusElement = document.getElementById('statusMessage');
            statusElement.textContent = message;
            statusElement.className = `status-message ${type}`;
            statusElement.style.display = 'block';
            
            setTimeout(() => {
                statusElement.style.display = 'none';
            }, 5000);
        }

        async function generateDocument() {
            if (!templateFile) {
                showStatus("Lütfen önce bir Word şablonu yükleyin.", "error");
                return;
            }

            try {
                // Form verilerini topla
                const formData = {
                    rutin_denetim: document.getElementById('rutin_denetim').checked ? '✓' : '◻',
                    sozlu_sikayet: document.getElementById('sozlu_sikayet').checked ? '✓' : '◻',
                    cagri_merkezi: document.getElementById('cagri_merkezi').checked ? '✓' : '◻',
                    info: document.getElementById('info').checked ? '✓' : '◻',
                    cimer: document.getElementById('cimer').checked ? '✓' : '◻',
                    dilekce: document.getElementById('dilekce').checked ? '✓' : '◻',
                    kayit_no: document.getElementById('kayit_no').value || '',
                    sira_no: document.getElementById('sira_no').value || '2025-3-1',
                    is_emri_id: document.getElementById('is_emri_id').value || '',
                    info_sayi: document.getElementById('info_sayi').value || '',
                    cimer_sayi: document.getElementById('cimer_sayi').value || '',
                    dilekce_tarih: document.getElementById('dilekce_tarih').value || '',
                    sahip_adi: document.getElementById('sahip_adi').value || '',
                    sahip_tc: document.getElementById('sahip_tc').value || '',
                    sahip_tel: document.getElementById('sahip_tel').value || '',
                    sahip_dogum: document.getElementById('sahip_dogum').value || '',
                    sahip_adres: document.getElementById('sahip_adres').value || '',
                    plaka: document.getElementById('plaka').value || '',
                    kooperatif: document.getElementById('kooperatif').value || '',
                    hat_no: document.getElementById('hat_no').value || '',
                    icerik: document.getElementById('icerik').value || ''
                };

                // Word belgesini oluştur
                const arrayBuffer = await readFileAsArrayBuffer(templateFile);
                
                // JSZip yapılandırması
                const zip = new JSZip(arrayBuffer);
                const doc = new docxtemplater();
                
                try {
                    doc.loadZip(zip);
                    
                    // Değişkenleri ayarla
                    doc.setData(formData);
                    
                    try {
                        doc.render();
                    } catch (renderError) {
                        console.warn("Render hatası:", renderError);
                        // Hata olsa bile devam et
                    }
                    
                    // Word belgesini oluştur
                    const out = doc.getZip().generate({
                        type: "blob",
                        mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
                        compression: "DEFLATE"
                    });

                    // Dosyayı indir
                    saveAs(out, `tutanak_${new Date().toISOString().slice(0,10)}.docx`);
                    showStatus("Belge başarıyla oluşturuldu ve indiriliyor...", "success");
                    
                } catch (error) {
                    console.error("Docxtemplater hatası:", error);
                    showStatus(`Belge oluşturma hatası: ${error.message}`, "error");
                }
                
            } catch (error) {
                console.error("Genel hata:", error);
                showStatus(`Bir hata oluştu: ${error.message}`, "error");
            }
        }

        function readFileAsArrayBuffer(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = (error) => {
                    console.error("Dosya okuma hatası:", error);
                    reject(error);
                };
                reader.readAsArrayBuffer(file);
            });
        }

        // Örnek verilerle formu doldur (isteğe bağlı)
        window.onload = function() {
            document.getElementById('is_emri_id').value = "EMR2025001";
            document.getElementById('info_sayi').value = "INF2025001";
            document.getElementById('cimer_sayi').value = "CIM2025001";
            document.getElementById('dilekce_tarih').value = "01.03.2025-123";
            document.getElementById('sahip_adi').value = "Ahmet Yılmaz";
            document.getElementById('plaka').value = "48 ABC 123";
        };
    </script>
</body>
</html>
