<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<title>Şablon Yükle & Belge Oluştur</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; max-width: 700px; }
  label { display: block; margin-top: 10px; }
  input[type="text"], input[type="date"], textarea { width: 100%; max-width: 400px; padding: 5px; }
  textarea { height: 70px; }
  #downloadLink { margin-top: 15px; display: inline-block; }
  #preview { border: 1px solid #ccc; padding: 10px; margin-top: 20px; max-width: 700px; white-space: pre-wrap; }
  .checkbox-group label { display: inline-block; width: 200px; }
</style>
</head>
<body>

<h2>Şablon Dosyası Yükle ve Belge Oluştur</h2>

<label>Şablon Dosyası (.docx): <input type="file" id="templateFile" accept=".docx" /></label>

<div class="checkbox-group">
  <h3>Seçenekler (Checkbox)</h3>
  <label><input type="checkbox" id="rutin_denetim" /> Rutin Denetim</label>
  <label><input type="checkbox" id="sozlu_sikayet" /> Sözlü/Telefon Şikayet</label>
  <label><input type="checkbox" id="cagri_merkezi" /> Çağrı Merkezi</label>
  <label><input type="checkbox" id="info" /> İnfo</label>
  <label><input type="checkbox" id="cimer" /> CİMER</label>
  <label><input type="checkbox" id="dilekce" /> Dilekçe</label>
</div>

<h3>Metin Alanları</h3>
<label>İş Emri ID: <input type="text" id="is_emri_id" /></label>
<label>Info Sayı: <input type="text" id="info_sayi" /></label>
<label>Dilekçe Tarih: <input type="date" id="dilekce_tarih" /></label>
<label>Sahip Adı: <input type="text" id="sahip_adi" /></label>
<label>Sahip TC: <input type="text" id="sahip_tc" /></label>
<label>Sahip Tel: <input type="text" id="sahip_tel" /></label>
<label>Sahip Doğum: <input type="date" id="sahip_dogum" /></label>
<label>Plaka: <input type="text" id="plaka" /></label>
<label>Kooperatif: <input type="text" id="kooperatif" /></label>
<label>Hat No: <input type="text" id="hat_no" /></label>
<label>Sahip Adres: <textarea id="sahip_adres"></textarea></label>
<label>İçerik: <textarea id="icerik"></textarea></label>

<button id="generate" disabled style="margin-top:20px;">Belgeyi Oluştur</button>
<a id="downloadLink" style="display:none;"></a>

<h3>Önizleme</h3>
<div id="preview"></div>

<script src="https://cdn.jsdelivr.net/npm/pizzip@3.1.1/dist/pizzip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/docxtemplater@3.28.1/build/docxtemplater.js"></script>
<script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>

<script>
  let loadedTemplateContent = null;

  document.getElementById('templateFile').addEventListener('change', function(evt) {
    const file = evt.target.files[0];
    if (!file) {
      alert("Lütfen bir .docx dosyası seçin.");
      return;
    }
    const reader = new FileReader();
    reader.onload = function(e) {
      loadedTemplateContent = e.target.result;
      alert("Şablon dosyası yüklendi. Artık belge oluşturabilirsiniz.");
      document.getElementById('generate').disabled = false;
    };
    reader.readAsArrayBuffer(file);
  });

  document.getElementById('generate').onclick = async function() {
    if (!loadedTemplateContent) {
      alert("Önce şablon dosyasını yükleyin.");
      return;
    }

    try {
      const zip = new PizZip(loadedTemplateContent);
      const doc = new window.docxtemplater(zip, { paragraphLoop: true, linebreaks: true });

      const data = {
        rutin_denetim: document.getElementById('rutin_denetim').checked ? "Rutin Denetim Metni" : "",
        sozlu_sikayet: document.getElementById('sozlu_sikayet').checked ? "Sözlü/Telefon Şikayet Metni" : "",
        cagri_merkezi: document.getElementById('cagri_merkezi').checked ? "Çağrı Merkezi Metni" : "",
        info: document.getElementById('info').checked ? "İnfo Metni" : "",
        cimer: document.getElementById('cimer').checked ? "CİMER Metni" : "",
        dilekce: document.getElementById('dilekce').checked ? "Dilekçe Metni" : "",

        is_emri_id: document.getElementById('is_emri_id').value,
        info_sayi: document.getElementById('info_sayi').value,
        dilekce_tarih: document.getElementById('dilekce_tarih').value,
        sahip_adi: document.getElementById('sahip_adi').value,
        sahip_tc: document.getElementById('sahip_tc').value,
        sahip_tel: document.getElementById('sahip_tel').value,
        sahip_dogum: document.getElementById('sahip_dogum').value,
        plaka: document.getElementById('plaka').value,
        kooperatif: document.getElementById('kooperatif').value,
        hat_no: document.getElementById('hat_no').value,
        sahip_adres: document.getElementById('sahip_adres').value,
        icerik: document.getElementById('icerik').value,
      };

      doc.render(data);

      const out = doc.getZip().generate({ type: "blob" });
      const url = URL.createObjectURL(out);

      const link = document.getElementById('downloadLink');
      link.href = url;
      link.download = "output.docx";
      link.style.display = "inline";
      link.textContent = "Belgeyi İndir";

      const arrayBuffer = await out.arrayBuffer();
      const result = await mammoth.convertToHtml({ arrayBuffer });
      document.getElementById('preview').innerHTML = result.value;

    } catch (error) {
      alert("Hata: " + error.message);
      console.error(error);
    }
  };
</script>

</body>
</html>
